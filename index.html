<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Resultado Preliminar CNU2 â€“ Extraoficial</title>

<script async src="https://www.googletagmanager.com/gtag/js?id=G-L04YT2TFYP"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-L04YT2TFYP');
</script>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

<style>
body{margin:0;font-family:Arial,sans-serif;background:#f4f6f8}

/* ===== HEADER ===== */
header{position:fixed;top:0;width:100%;background:#0b3c6d;color:white;padding:8px 10px;z-index:1000}
header h3{margin:4px 0 6px;font-size:16px}
header .linha{display:flex;gap:6px;flex-wrap:wrap; align-items: center;}
header select,header input,header button{padding:6px;font-size:13px}
header button:disabled{opacity:0.6;cursor:not-allowed}

/* Estilo especÃ­fico para os botÃµes de exportaÃ§Ã£o */
#btnPdf { background-color: #dc3545; color: white; border: none; border-radius: 4px; }
#btnCsv { background-color: #198754; color: white; border: none; border-radius: 4px; }

/* ===== MAIN ===== */
main{padding:130px 10px 110px}
#info{font-weight:bold;margin-bottom:6px}
.tabela-container{max-height:65vh;overflow:auto;background:white}

/* ===== TABELA ===== */
table{width:100%;border-collapse:collapse;font-size:13px}
th{position:sticky;top:0;background:#e9ecef}
td,th{border:1px solid #ccc;padding:6px}

/* ===== FOOTER ===== */
.footer-pix{position:fixed;bottom:0;width:100%;background:#0b3c6d;color:white;padding:8px 14px;box-sizing:border-box}
.footer-pix{display:flex;align-items:center;justify-content:center}
.pix-info{text-align:center}
.pix-info button{margin-top:4px;padding:6px 16px;background:#28a745;border:none;color:white;border-radius:6px;cursor:pointer;font-size:13px}

/* QR */
.qr-pix{position:absolute;right:14px;bottom:6px;text-align:center}
.qr-pix img{width:110px;height:110px;background:white;padding:4px;border-radius:6px}
.qr-texto{font-size:10px;margin-top:2px;opacity:0.9}

/* MOBILE */
@media (max-width:600px){
.footer-pix{justify-content:space-between}
.pix-info{font-size:11px;max-width:60%;text-align:left}
.qr-pix{position:static;margin-left:auto}
.qr-pix img{width:70px;height:70px}
.qr-texto{font-size:9px}
}

/* ===== POP-UP (NOVO) ===== */
.popup-overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.6);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:2000;
}
.popup-content{
  background:#fff;
  padding:20px;
  border-radius:10px;
  max-width:360px;
  width:90%;
  text-align:center;
}
.popup-content button{
  margin:8px 6px;
  padding:8px 16px;
  border:none;
  border-radius:6px;
  cursor:pointer;
  font-size:14px;
}
.btn-copy{background:#28a745;color:#fff}
.btn-ok{background:#0b3c6d;color:#fff}
</style>
</head>

<body>

<header>
<h3>RESULTADO PRELIMINAR CNU2 â€“ EXTRAOFICIAL</h3>
<div class="linha">
<select id="fCargo"><option value="">CARGO</option></select>
<select id="fBloco" disabled><option value="">BLOCO</option></select>
<select id="fEspecialidade" disabled><option value="">ESPECIALIDADE</option></select>
<button id="btnVer" disabled>Ver resultado</button>
</div>
<div class="linha" style="margin-top: 5px;">
<input id="fNome" placeholder="Buscar nome" disabled>
<button id="btnPdf" disabled>Baixar PDF</button>
<button id="btnCsv" disabled>Baixar Excel</button>
</div>
</header>

<main>
<div id="info"></div>
<div class="tabela-container">
<table>
<thead id="thead"></thead>
<tbody id="tbody"></tbody>
</table>
</div>
</main>

<footer class="footer-pix">
<div class="pix-info">
ðŸ’™ Este site foi criado de forma independente para ajudar candidatos.<br>
<small>Se ele te ajudou, considere apoiar.</small><br>
<button onclick="copiarPix()">Copiar Pix</button>
</div>
<div class="qr-pix">
<img src="qr-pix.png">
<div class="qr-texto">Escaneie para doar via Pix</div>
</div>
</footer>

<div id="popupPix" class="popup-overlay">
<div class="popup-content">
<p><strong>Este site Ã© mantido de forma independente.</strong></p>
<p><small>Se foi Ãºtil para vocÃª, considere apoiar com qualquer valor ðŸ’™</small></p>
<button class="btn-copy" onclick="copiarPixPopup()">Copiar Pix</button>
<button class="btn-ok" onclick="confirmarPopup()">OK</button>
</div>
</div>

<script>
let dados=[],filtradosBase=[];

function normalizar(txt){
return txt?.toString().normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase();
}

Papa.parse("dados_concurso.csv",{download:true,header:true,skipEmptyLines:true,complete:r=>{
dados=r.data;preencherCargos();
}});

function preencherCargos(){
[...new Set(dados.map(d=>d.CARGO).filter(Boolean))].sort()
.forEach(v=>fCargo.add(new Option(v,v)));
}

fCargo.onchange=()=>{
fBloco.innerHTML='<option value="">BLOCO</option>';
fEspecialidade.innerHTML='<option value="">ESPECIALIDADE</option>';
fBloco.disabled=fEspecialidade.disabled=btnVer.disabled=true;
document.getElementById('btnPdf').disabled = true;
document.getElementById('btnCsv').disabled = true;

if(!fCargo.value)return;
[...new Set(dados.filter(d=>d.CARGO===fCargo.value).map(d=>d.BLOCO).filter(Boolean))]
.sort().forEach(v=>fBloco.add(new Option(v,v)));
fBloco.disabled=false;
};

fBloco.onchange=()=>{
fEspecialidade.innerHTML='<option value="">ESPECIALIDADE</option>';
fEspecialidade.disabled=btnVer.disabled=true;
if(!fBloco.value)return;
[...new Set(dados.filter(d=>d.CARGO===fCargo.value&&d.BLOCO===fBloco.value)
.map(d=>d.ESPECIALIDADE).filter(Boolean))]
.sort().forEach(v=>fEspecialidade.add(new Option(v,v)));
fEspecialidade.disabled=false;
};

fEspecialidade.onchange=()=>{
btnVer.disabled=!(fCargo.value&&fBloco.value&&fEspecialidade.value);
};

btnVer.onclick=()=>{
document.getElementById("popupPix").style.display="flex";
};

function confirmarPopup(){
if(typeof gtag==="function"){
gtag('event','popup_ok',{event_category:'engajamento'});
}
document.getElementById("popupPix").style.display="none";
filtradosBase=dados.filter(d=>d.CARGO===fCargo.value&&d.BLOCO===fBloco.value&&d.ESPECIALIDADE===fEspecialidade.value);
fNome.disabled=false;

document.getElementById('btnPdf').disabled = false;
document.getElementById('btnCsv').disabled = false;

render(filtradosBase);
}

fNome.addEventListener("input",()=>{
const termo=normalizar(fNome.value);
render(filtradosBase.filter(d=>normalizar(d.NOME).includes(termo)));
});

function render(lista){
if(!lista.length){tbody.innerHTML="";info.innerText="Nenhum resultado encontrado.";return;}
const cols=Object.keys(lista[0]);
thead.innerHTML="<tr>"+cols.map(c=>`<th>${c}</th>`).join("")+"</tr>";
tbody.innerHTML=lista.map(l=>"<tr>"+cols.map(c=>`<td>${l[c]??""}</td>`).join("")+"</tr>").join("");
info.innerText=`${lista.length} registros encontrados.`;
}

function copiarPix(){
navigator.clipboard.writeText("68f58fac-9cee-4a2e-a636-cccca267d3b9");
alert("Chave Pix copiada!");
}

function copiarPixPopup(){
navigator.clipboard.writeText("68f58fac-9cee-4a2e-a636-cccca267d3b9");
if(typeof gtag==="function"){
gtag('event','pix_copiado',{event_category:'doacao'});
}
alert("Chave Pix copiada!");
}

// ==========================================
// EXPORTAR PDF COM RODAPÃ‰ EM TODAS AS PÃGINAS
// ==========================================
document.getElementById('btnPdf').onclick = () => {
    if (!filtradosBase || filtradosBase.length === 0) return;

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('l', 'mm', 'a4'); // Paisagem

    const colunas = Object.keys(filtradosBase[0]);
    const linhas = filtradosBase.map(item => colunas.map(col => item[col] || ""));

    doc.autoTable({
        head: [colunas],
        body: linhas,
        startY: 22, 
        theme: 'grid',
        styles: { fontSize: 7, cellPadding: 1 },
        headStyles: { fillColor: [11, 60, 109] },
        // A mÃ¡gica acontece aqui: didDrawPage roda a cada pÃ¡gina gerada
        didDrawPage: function (data) {
            // CABEÃ‡ALHO (Repete em todas as pÃ¡ginas)
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            doc.text(`Cargo: ${fCargo.value}`, 14, 10);
            doc.setFontSize(10);
            doc.text(`Bloco: ${fBloco.value} | Especialidade: ${fEspecialidade.value}`, 14, 16);

            // RODAPÃ‰ (Repete em todas as pÃ¡ginas)
            const pageSize = doc.internal.pageSize;
            const pageHeight = pageSize.height ? pageSize.height : pageSize.getHeight();
            const pageWidth = pageSize.width ? pageSize.width : pageSize.getWidth();
            
            doc.setFontSize(8);
            doc.setTextColor(100); // Cinza
            
            // Texto do rodapÃ©
            const textoRodape = "Projeto independente. Se foi Ãºtil, apoie via Pix: 68f58fac-9cee-4a2e-a636-cccca267d3b9";
            
            // Centraliza o texto no rodapÃ©
            doc.text(textoRodape, pageWidth / 2, pageHeight - 10, { align: 'center' });
        }
    });

    doc.save(`Resultado_${fCargo.value}.pdf`);
};

// EXPORTAR EXCEL
document.getElementById('btnCsv').onclick = () => {
    if (!filtradosBase || filtradosBase.length === 0) return;

    const csv = Papa.unparse(filtradosBase, {
        delimiter: ";",
        header: true
    });

    const blob = new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    
    if (navigator.msSaveBlob) {
        navigator.msSaveBlob(blob, "resultado.csv");
    } else {
        link.href = URL.createObjectURL(blob);
        link.download = `Resultado_${fCargo.value}.csv`;
        link.style.display = "none";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
};
</script>

</body>
</html>